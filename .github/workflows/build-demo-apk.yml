name: Build Demo APK

on:
  workflow_dispatch:
    inputs:
      version_suffix:
        description: 'Version suffix (optional, e.g., hotfix)'
        required: false
        default: ''

jobs:
  build:
    name: Build Demo Debug APK
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v6
        with:
          ref: main

      - name: Generate version tag
        id: version
        run: |
          # Format: YYYY.MM.RunNumber-Vidos-Demo
          YEAR=$(date +%Y)
          MONTH=$(date +%-m)
          RUN=${{ github.run_number }}
          SUFFIX="${{ github.event.inputs.version_suffix }}"
          
          if [ -n "$SUFFIX" ]; then
            TAG="${YEAR}.${MONTH}.${RUN}-${SUFFIX}-Vidos-Demo"
          else
            TAG="${YEAR}.${MONTH}.${RUN}-Vidos-Demo"
          fi
          
          echo "tag=$TAG" >> $GITHUB_OUTPUT
          echo "Generated version: $TAG"

      - name: Set up JDK 17
        uses: actions/setup-java@v5
        with:
          java-version: '17'
          distribution: 'temurin'

      - name: Setup Gradle
        uses: gradle/actions/setup-gradle@v5

      - name: Grant execute permission for gradlew
        run: chmod +x ./gradlew

      - name: Build Demo Debug APK
        run: ./gradlew assembleDemoDebug

      - name: Get APK path and rename
        id: apk_path
        run: |
          APK_PATH=$(find app/build/outputs/apk/demo/debug -name "*.apk" | head -n 1)
          APK_DIR=$(dirname "$APK_PATH")
          NEW_NAME="eudi-wallet-${{ steps.version.outputs.tag }}.apk"
          mv "$APK_PATH" "$APK_DIR/$NEW_NAME"
          echo "apk_path=$APK_DIR/$NEW_NAME" >> $GITHUB_OUTPUT
          echo "apk_name=$NEW_NAME" >> $GITHUB_OUTPUT

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ steps.version.outputs.tag }}
          name: "EUDI Wallet Demo - ${{ steps.version.outputs.tag }}"
          draft: false
          prerelease: true
          files: ${{ steps.apk_path.outputs.apk_path }}
          body: |
            ## EUDI Wallet Demo APK
            
            **Version:** ${{ steps.version.outputs.tag }}
            **Build:** #${{ github.run_number }}
            **Commit:** ${{ github.sha }}
            
            ### Install
            Download the APK and install on your Android device (requires Android 10+).
            
            > ⚠️ This is a debug build with a self-signed certificate.
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
